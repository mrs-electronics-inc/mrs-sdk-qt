name: Build MRS SDK Qt VM Image

on:
  push:
    branches:
      - main
      - 27-add-vm-image-workflow
    tags:
      - "v*.*.*"

concurrency:
  group: vm-build
  cancel-in-progress: false

jobs:
  build-vm:
    name: Build OVA Image
    runs-on: ubuntu-latest

    # High resource requirements for VM building
    # Standard GitHub runners have 4 CPUs and 16GB RAM

    permissions:
      contents: read
      actions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build variables
        id: vars
        run: |
          BUILD_DATE=$(date +%Y%m%d)
          BUILD_TIME=$(date +%H%M%S)

          # Determine output filename
          OUTPUT_FILENAME="mrs-sdk-qt-${BUILD_DATE}-${BUILD_TIME}.ova"

          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "output_filename=${OUTPUT_FILENAME}" >> $GITHUB_OUTPUT

          # Extract version tag if this is a tagged release
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref }}"
            VERSION="${VERSION#refs/tags/}"
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Install Packer
        run: |
          echo "Installing Packer..."

          # Download latest Packer version
          PACKER_VERSION="1.14.3"
          DOWNLOAD_URL="https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip"
          CHECKSUM_URL="https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_SHA256SUMS"

          mkdir -p "${HOME}/packer"
          cd "${HOME}/packer"

          # Download checksums and verify signature
          wget -q "$CHECKSUM_URL" -O SHA256SUMS
          wget -q "${CHECKSUM_URL}.sig" -O SHA256SUMS.sig

          # Download Packer binary
          PACKER_ZIP="packer_${PACKER_VERSION}_linux_amd64.zip"
          wget -q "$DOWNLOAD_URL" -O "$PACKER_ZIP"

          # Verify checksum
          sha256sum -c <(grep "$PACKER_ZIP" SHA256SUMS) || {
            echo "Checksum verification failed!"
            exit 1
          }

          unzip -q "$PACKER_ZIP"
          rm "$PACKER_ZIP" SHA256SUMS SHA256SUMS.sig

          echo "${HOME}/packer" >> $GITHUB_PATH
          export PATH="${HOME}/packer:$PATH"

          # Verify installation
          "${HOME}/packer/packer" version

      - name: Install VirtualBox
        run: |
          echo "Installing VirtualBox and dependencies..."

          sudo apt-get update
          sudo apt-get install -y \
            virtualbox \
            virtualbox-dkms \
            libvirt-dev

          # Verify kernel modules were built
          echo "Verifying VirtualBox kernel modules..."
          if ! lsmod | grep -q vboxdrv; then
            echo "Warning: vboxdrv kernel module not loaded. Attempting to load..."
            sudo modprobe vboxdrv || {
              echo "Failed to load vboxdrv kernel module!"
              exit 1
            }
          fi
          echo "VirtualBox kernel modules verified successfully."

       - name: Initialize Packer
         working-directory: vm
         run: |
           echo "Initializing Packer configuration..."
           export PATH="${HOME}/packer:$PATH"
           packer init .

       - name: Format and validate Packer configuration
         working-directory: vm
         run: |
           echo "Validating Packer configuration..."
           export PATH="${HOME}/packer:$PATH"
           packer fmt -check .
           packer validate .

       - name: Build OVA image
         working-directory: vm
         run: |
           echo "Building OVA image..."

           export PATH="${HOME}/packer:$PATH"

           BUILD_ARGS=(-var "build_date=${{ steps.vars.outputs.build_date }}")

           # Add version tag if this is a tagged release
           if [[ -n "${{ steps.vars.outputs.version }}" ]]; then
             BUILD_ARGS+=(-var "version=${{ steps.vars.outputs.version }}")
           fi

           packer build \
             "${BUILD_ARGS[@]}" \
             -color=false \
             -timestamp-ui \
             .
         timeout-minutes: 120

      - name: List build artifacts
        if: always()
        run: |
          echo "Build artifacts:"
          find . -name "*.ova" -o -name "manifest.json" | head -20

      - name: Upload OVA artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: mrs-sdk-qt-ova
          path: |
            output/*.ova
            output/manifest.json
          retention-days: 30
          compression-level: 0

      - name: Notify on failure
        if: failure()
        run: |
          echo "⚠️  VM build failed!"
          echo "Check the workflow logs for details."
          exit 1
